<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Lightning-dev] Reason for having HMACs in Sphinx
   </TITLE>
   <LINK REL="Index" HREF="https://lists.linuxfoundation.org/pipermail/lightning-dev/2018-December/index.html" >
   <LINK REL="made" HREF="mailto:lightning-dev%40lists.linuxfoundation.org?Subject=Re:%20Re%3A%20%5BLightning-dev%5D%20Reason%20for%20having%20HMACs%20in%20Sphinx&In-Reply-To=%3C875zw6adaz.fsf%40gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="001725.html">
   <LINK REL="Next"  HREF="001719.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Lightning-dev] Reason for having HMACs in Sphinx</H1>
    <B>Christian Decker</B> 
    <A HREF="mailto:lightning-dev%40lists.linuxfoundation.org?Subject=Re:%20Re%3A%20%5BLightning-dev%5D%20Reason%20for%20having%20HMACs%20in%20Sphinx&In-Reply-To=%3C875zw6adaz.fsf%40gmail.com%3E"
       TITLE="[Lightning-dev] Reason for having HMACs in Sphinx">decker.christian at gmail.com
       </A><BR>
    <I>Thu Dec  6 15:24:20 UTC 2018</I>
    <P><UL>
        <LI>Previous message: <A HREF="001725.html">[Lightning-dev] Reason for having HMACs in Sphinx
</A></li>
        <LI>Next message: <A HREF="001719.html">[Lightning-dev] Reason for having HMACs in Sphinx
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1726">[ date ]</a>
              <a href="thread.html#1726">[ thread ]</a>
              <a href="subject.html#1726">[ subject ]</a>
              <a href="author.html#1726">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Corn&#233; Plooy &lt;<A HREF="https://lists.linuxfoundation.org/mailman/listinfo/lightning-dev">corne at bitonic.nl</A>&gt; writes:

&gt;&gt;<i> The total_decorrelation_secrets serves as the payer-generated shared
</I>&gt;&gt;<i> secret between payer and payee.  B cannot learn this, and thus cannot
</I>&gt;&gt;<i> fake its own secret.  Even if it instead offers ((I + K[A]) + k[z] *
</I>&gt;&gt;<i> G) for a new secret k[z], it cannot know how to change
</I>&gt;&gt;<i> total_decorrelation_secrets from k[a] + k[b] to k[a] + k[z] instead.
</I>&gt;&gt;<i>
</I>&gt;<i> The way things are now, the ephemeral key generation and the payment
</I>&gt;<i> hash/preimage generation are completely unrelated. This is what allows
</I>&gt;<i> an attacker to use the same payment hash, and use his own ephemeral key
</I>&gt;<i> pair to create a new onion packet around it.
</I>
That is correct, one is generated by the recipient (secret and preimage)
and the other one is generated by the sender (ephemeral key). Mixing the
two seems very unwise, since the sender has very little control over
what the effective ephemeral key that is going to be used for the last
hop. This is the same issue that we have with rendez-vous routing, i.e.,
that if we require the ephemeral key to be something specific at a given
node we'd be breaking the hardness assumption of for the ephemeral key
rotation.

&gt;<i> Primarily, path decorrelation replaces the payment hash/preimage part.
</I>&gt;<i> Maybe I still don't understand something, but if that's the only thing
</I>&gt;<i> (without changing the ephemeral key / onion shared secret generation),
</I>&gt;<i> attacking the direct neighbor should still work; in your case, B would
</I>&gt;<i> still offer ((I + K[A]) + K[B]) to C, with an onion packet B created
</I>&gt;<i> himself. I'm not familiar enough with the path correlation to understand
</I>&gt;<i> what happens after step 6, but for C it looks the same, so she should do
</I>&gt;<i> the same.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> I do see that, if you couple the &quot;H&quot;TLC payment secret generation to the
</I>&gt;<i> onion shared secret generation, you can make the attack impossible. Do I
</I>&gt;<i> understand correctly that this is the idea? After all, C still needs to
</I>&gt;<i> receive k somehow; my crypto math isn't that good, but my intuitive
</I>&gt;<i> guess is that i + k is the secret that allows C to claim funds locked in
</I>&gt;<i> ((I + K[A]) + K[B]) =? (i + (k[a] + k[b])) * G. If k is submitted from A
</I>&gt;<i> to C through some mechanism that replaces the current ephemeral key
</I>&gt;<i> system, then I understand what you're at.
</I>
I can't quite follow where we would be mixing in the ephemeral key here,
could you elaborate on that?

&gt;<i> Assuming this is the case, it's pretty neat. I do wonder how it
</I>&gt;<i> interacts with rendezvous routing. If the sender and receiver each
</I>&gt;<i> create the k[..] values for their own part of the route, can the
</I>&gt;<i> receiver-generated onion packet still use points of the form ((I + K[A])
</I>&gt;<i> + K[B]), including K[..] values related to the sender side? I need to
</I>&gt;<i> dig deeper into this path decorrelation idea.
</I>
Since we have very little control over what ephemeral key will actually
be presented to the last hop if we have a multi-hop route, we can't
really hide any information in the ephemeral key itself. What we could
do is change the way the last hop generates the shared secret from it,
i.e., have a last hop mode and a forwarding hop mode, and mix in the
payment secret somehow, but I can't think of a good way to do that, and
it seems contorted. Let's just have the sender prove knowledge of the
original invoice by adding a TLV field with a shared secret from the
invoice instead.

Cheers,
Christian
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="001725.html">[Lightning-dev] Reason for having HMACs in Sphinx
</A></li>
	<LI>Next message: <A HREF="001719.html">[Lightning-dev] Reason for having HMACs in Sphinx
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1726">[ date ]</a>
              <a href="thread.html#1726">[ thread ]</a>
              <a href="subject.html#1726">[ subject ]</a>
              <a href="author.html#1726">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.linuxfoundation.org/mailman/listinfo/lightning-dev">More information about the Lightning-dev
mailing list</a><br>
</body></html>
