<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Lightning-dev] Reuse of payment_hash in lightning invoices
   </TITLE>
   <LINK REL="Index" HREF="https://lists.linuxfoundation.org/pipermail/lightning-dev/2019-January/index.html" >
   <LINK REL="made" HREF="mailto:lightning-dev%40lists.linuxfoundation.org?Subject=Re:%20Re%3A%20%5BLightning-dev%5D%20Reuse%20of%20payment_hash%20in%20lightning%20invoices&In-Reply-To=%3CCAFQp%2BC2qdfLpvgo25NN3tZTytu4gp24fEZKS%2Bhp81atFzWti8w%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="001782.html">
   <LINK REL="Next"  HREF="001844.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Lightning-dev] Reuse of payment_hash in lightning invoices</H1>
    <B>Andrea RASPITZU</B> 
    <A HREF="mailto:lightning-dev%40lists.linuxfoundation.org?Subject=Re:%20Re%3A%20%5BLightning-dev%5D%20Reuse%20of%20payment_hash%20in%20lightning%20invoices&In-Reply-To=%3CCAFQp%2BC2qdfLpvgo25NN3tZTytu4gp24fEZKS%2Bhp81atFzWti8w%40mail.gmail.com%3E"
       TITLE="[Lightning-dev] Reuse of payment_hash in lightning invoices">andrea.raspitzu at acinq.fr
       </A><BR>
    <I>Thu Jan  3 15:35:01 UTC 2019</I>
    <P><UL>
        <LI>Previous message: <A HREF="001782.html">[Lightning-dev] Reuse of payment_hash in lightning invoices
</A></li>
        <LI>Next message: <A HREF="001844.html">[Lightning-dev] Reuse of payment_hash in lightning invoices
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1786">[ date ]</a>
              <a href="thread.html#1786">[ thread ]</a>
              <a href="subject.html#1786">[ subject ]</a>
              <a href="author.html#1786">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Okay so the knowledge of a preimage for a certain payment_hash is the
sufficient (and only) payment proof for the payer. But in any case the
reuse of payment_hashes should be strongly discouraged, in the donations
scenario 2 donors will send across the network a payment for the same
preimage and if the routes overlap (as it's likely to happen getting close
to the recipient) an intermediate routing node can effectively steal the
payment from the recipient. Shouldn't we make this clear in BOLT11?

Cheers, Andrea.



On Thu, 3 Jan 2019 at 14:13, ZmnSCPxj &lt;<A HREF="https://lists.linuxfoundation.org/mailman/listinfo/lightning-dev">ZmnSCPxj at protonmail.com</A>&gt; wrote:

&gt;<i> Good morning Andrea,
</I>&gt;<i>
</I>&gt;<i> &gt; For example a malicious receiver can provide an invoice with assisted
</I>&gt;<i> routes where among those he/she controls a node and that node won't forward
</I>&gt;<i> to the htlc but steal the funds instead (the preimage is known to the
</I>&gt;<i> intermediate node as well), thus it will be claimed that the payment hasn't
</I>&gt;<i> been received. If the above is correct then there should be at least a
</I>&gt;<i> warning in the spec regarding the reuse of payment_hash in invoices.
</I>&gt;<i>
</I>&gt;<i> The fact that ultimate payer has received the payment preimage is
</I>&gt;<i> considered sufficient proof of payment.
</I>&gt;<i> Thus, in case of reuse, the fact that the ultimate payer has received the
</I>&gt;<i> payment preimage is sufficient proof of payment, and whatever the receiver
</I>&gt;<i> claims is to be ignored: the payment preimage in possession of the ultimate
</I>&gt;<i> payee is considered the whole of the proof of payment.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt;a malicious receiver can provide an invoice with assisted routes where
</I>&gt;<i> among those he/she controls a node and that node won't forward to the htlc
</I>&gt;<i> but steal the funds instead
</I>&gt;<i>
</I>&gt;<i> Then the receiver has received it, not on the purported final node, but on
</I>&gt;<i> another node it controls, and the fact that the ultimate payer has received
</I>&gt;<i> the payment preimage is sufficient proof of that.
</I>&gt;<i>
</I>&gt;<i> Obviously, if the receiver knows it does not control the entire Lightning
</I>&gt;<i> Network, it should not reuse payment hashes, since intermediate nodes it
</I>&gt;<i> does not control could claim the payment and give the proof-of-payment to
</I>&gt;<i> the ultimate payer.
</I>&gt;<i> This can be clarified, but in the context of proofs, the attack you
</I>&gt;<i> described is not possible, since the possession of the payment preimage is
</I>&gt;<i> itself the entirety of the proof of the payment, regardless of what the
</I>&gt;<i> receiver claims.
</I>&gt;<i>
</I>&gt;<i> Regards,
</I>&gt;<i> ZmnSCPxj
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.linuxfoundation.org/pipermail/lightning-dev/attachments/20190103/ce268371/attachment.html">http://lists.linuxfoundation.org/pipermail/lightning-dev/attachments/20190103/ce268371/attachment.html</A>&gt;
</PRE>
















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="001782.html">[Lightning-dev] Reuse of payment_hash in lightning invoices
</A></li>
	<LI>Next message: <A HREF="001844.html">[Lightning-dev] Reuse of payment_hash in lightning invoices
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1786">[ date ]</a>
              <a href="thread.html#1786">[ thread ]</a>
              <a href="subject.html#1786">[ subject ]</a>
              <a href="author.html#1786">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.linuxfoundation.org/mailman/listinfo/lightning-dev">More information about the Lightning-dev
mailing list</a><br>
</body></html>
