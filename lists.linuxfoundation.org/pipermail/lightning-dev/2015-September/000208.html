<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Lightning-dev] Onion routing design.
   </TITLE>
   <LINK REL="Index" HREF="https://lists.linuxfoundation.org/pipermail/lightning-dev/2015-September/index.html" >
   <LINK REL="made" HREF="mailto:lightning-dev%40lists.linuxfoundation.org?Subject=Re:%20Re%3A%20%5BLightning-dev%5D%20Onion%20routing%20design.&In-Reply-To=%3C87io72oi27.fsf%40rustcorp.com.au%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000207.html">
   <LINK REL="Next"  HREF="000192.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Lightning-dev] Onion routing design.</H1>
    <B>Rusty Russell</B> 
    <A HREF="mailto:lightning-dev%40lists.linuxfoundation.org?Subject=Re:%20Re%3A%20%5BLightning-dev%5D%20Onion%20routing%20design.&In-Reply-To=%3C87io72oi27.fsf%40rustcorp.com.au%3E"
       TITLE="[Lightning-dev] Onion routing design.">rusty at rustcorp.com.au
       </A><BR>
    <I>Tue Sep 22 10:38:08 UTC 2015</I>
    <P><UL>
        <LI>Previous message: <A HREF="000207.html">[Lightning-dev] Onion routing design.
</A></li>
        <LI>Next message: <A HREF="000192.html">[Lightning-dev] Decker&amp;Wattenhofer channels
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#208">[ date ]</a>
              <a href="thread.html#208">[ thread ]</a>
              <a href="subject.html#208">[ subject ]</a>
              <a href="author.html#208">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Zooko Wilcox-OHearn &lt;<A HREF="https://lists.linuxfoundation.org/mailman/listinfo/lightning-dev">zooko at leastauthority.com</A>&gt; writes:
&gt;<i> Could you please point me to any notes about requirements/desiderata?
</I>
They're mainly spread out over the mailing list discussions, but it's
pretty simple:

1) It's a source routing network, so the sender details the payment path.
   Since fees vary with path, and the sender pays, this is the simplest.

2) For financial privacy reasons, minimizing the knowledge of any part
   of the network makes sense.

Thus, an onion routing-style setup where each node only knows prev and
next seems most sensible.  It's not quite as good as you might expect,
because the payment is trivially correlated (it requires the same R
value) so if you control two nodes on the path you can connect them.

I am currently working on some test code which works like so:

  #define MESSAGE_SIZE 128
  #define MAX_HOPS 20

  // One node hop
  struct hop {
	unsigned char hmac[SHA256_DIGEST_LENGTH];
	/* FIXME: Must use parse/serialize functions. */
	secp256k1_pubkey_type pubkey;
	unsigned char msg[MESSAGE_SIZE];
  };

  // Full route description.
  struct onion {
	struct hop hop[MAX_HOPS];
  };

Receive on a node works like so:
1) Use ECDH on onion-&gt;hop[0].pubkey and my privkey to extract secret key.
2) Use this to derive
   - enckey (SHA256(seckey || 0)
   - hmackey (SHA256(seckey || 1)
   - iv (SHA256(seckey || 2)
   - pad_iv (SHA256(seckey || 3)
3) Check HMAC of every part of struct onion after hmac (including pubkey,
   why not?).  If wrong, stop.
4) Decrypt (AES 256 CTR mode, using enckey and iv above) struct onion
   from pubkey onwards.
5) First struct hop is for us.
6) To forward, remove first hop, and append padding (thus keeping total
   length the same).
7) Padding is generated by AES-256-CTR encrypting all-zeroes with enckey
   and pad_iv.

The result should be that even final node has no idea of path length.

It's a bit tricky to generate this onion correctly (I know, my code is
still buggy!).  But it's perfectly possible.  Unused hops are filled
with random garbage.

Cheers,
Rusty.
</PRE>




<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000207.html">[Lightning-dev] Onion routing design.
</A></li>
	<LI>Next message: <A HREF="000192.html">[Lightning-dev] Decker&amp;Wattenhofer channels
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#208">[ date ]</a>
              <a href="thread.html#208">[ thread ]</a>
              <a href="subject.html#208">[ subject ]</a>
              <a href="author.html#208">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.linuxfoundation.org/mailman/listinfo/lightning-dev">More information about the Lightning-dev
mailing list</a><br>
</body></html>
