<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Lightning-dev] [PATCH] First draft of option_simplfied_commitment
   </TITLE>
   <LINK REL="Index" HREF="https://lists.linuxfoundation.org/pipermail/lightning-dev/2018-November/index.html" >
   <LINK REL="made" HREF="mailto:lightning-dev%40lists.linuxfoundation.org?Subject=Re:%20Re%3A%20%5BLightning-dev%5D%20%5BPATCH%5D%20First%20draft%20of%0A%20option_simplfied_commitment&In-Reply-To=%3C1ea6ecfd-0f17-4aab-44c8-3c3e457cc4d6%40bluematt.me%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="001644.html">
   <LINK REL="Next"  HREF="001651.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Lightning-dev] [PATCH] First draft of option_simplfied_commitment</H1>
    <B>Matt Corallo</B> 
    <A HREF="mailto:lightning-dev%40lists.linuxfoundation.org?Subject=Re:%20Re%3A%20%5BLightning-dev%5D%20%5BPATCH%5D%20First%20draft%20of%0A%20option_simplfied_commitment&In-Reply-To=%3C1ea6ecfd-0f17-4aab-44c8-3c3e457cc4d6%40bluematt.me%3E"
       TITLE="[Lightning-dev] [PATCH] First draft of option_simplfied_commitment">lf-lists at mattcorallo.com
       </A><BR>
    <I>Wed Nov 21 17:55:33 UTC 2018</I>
    <P><UL>
        <LI>Previous message: <A HREF="001644.html">[Lightning-dev] [PATCH] First draft of option_simplfied_commitment
</A></li>
        <LI>Next message: <A HREF="001651.html">[Lightning-dev] [PATCH] First draft of	option_simplfied_commitment
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1647">[ date ]</a>
              <a href="thread.html#1647">[ thread ]</a>
              <a href="subject.html#1647">[ subject ]</a>
              <a href="author.html#1647">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Oh, also, obviously, the HTLC transactions need a pushme output, though 
luckily only one for the side we expect to be broadcasting the transaction.

On 11/21/18 2:54 AM, Matt Corallo wrote:
&gt;<i> Not sure if others already realized this, but in thinking about our RBF 
</I>&gt;<i> policy hack from Adelaide a bit more, to allow the carve-out exception 
</I>&gt;<i> of &quot;last tx in a package, which has only one unconfirmed ancestor&quot; to 
</I>&gt;<i> always be available for the &quot;honest party&quot; when broadcasting a 
</I>&gt;<i> commitment transaction, we also need at least a CSV delay of 1 block on 
</I>&gt;<i> the HTLC transaction outputs (as otherwise those transactions could 
</I>&gt;<i> count as the carve-out tx).
</I>&gt;<i> 
</I>&gt;<i> Matt
</I>&gt;<i> 
</I>&gt;<i> On 11/21/18 2:17 AM, Rusty Russell wrote:
</I>&gt;&gt;<i> I'm also starting to implement this, to see what I missed!
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Original at <A HREF="https://github.com/lightningnetwork/lightning-rfc/pull/513">https://github.com/lightningnetwork/lightning-rfc/pull/513</A>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Pasted here for your reading convenience:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> - Option is sticky; it set at open time, it stays with channel
</I>&gt;&gt;<i> &#160;&#160; - I didn't want to have to handle penalty txs on channels which switch
</I>&gt;&gt;<i> &#160;&#160; - We could, however, upgrade on splice.
</I>&gt;&gt;<i> - Feerate is fixed at 253
</I>&gt;&gt;<i> &#160;&#160; - `feerate_per_kw` is still in open /accept (just ignored): 
</I>&gt;&gt;<i> multifund may want it.
</I>&gt;&gt;<i> - closing tx negotiates *upwards* not *downwards*
</I>&gt;&gt;<i> &#160;&#160; - Starting from base fee of commitment tx = 282 satoshi.
</I>&gt;&gt;<i> - to_remote output is always CSV delayed.
</I>&gt;&gt;<i> - pushme outputs are paid for by funder, but only exist if the matching
</I>&gt;&gt;<i> &#160;&#160; to_local/remote output exists.
</I>&gt;&gt;<i> - After 10 blocks, they become anyone-can-spend (they need to see the
</I>&gt;&gt;<i> &#160;&#160; to-local/remote witness script though).
</I>&gt;&gt;<i> - remotepubkey is not rotated.
</I>&gt;&gt;<i> - You must spend your pushme output; you may sweep for others.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Signed-off-by: Rusty Russell &lt;<A HREF="https://lists.linuxfoundation.org/mailman/listinfo/lightning-dev">rusty at rustcorp.com.au</A>&gt;
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> diff --git a/02-peer-protocol.md b/02-peer-protocol.md
</I>&gt;&gt;<i> index 7cf9ebf..6ec1155 100644
</I>&gt;&gt;<i> --- a/02-peer-protocol.md
</I>&gt;&gt;<i> +++ b/02-peer-protocol.md
</I>&gt;&gt;<i> @@ -133,7 +133,9 @@ node can offer.
</I>&gt;&gt;<i> &#160; (i.e. 1/4 the more normally-used 'satoshi per 1000 vbytes') that this
</I>&gt;&gt;<i> &#160; side will pay for commitment and HTLC transactions, as described in
</I>&gt;&gt;<i> &#160; [BOLT #3](03-transactions.md#fee-calculation) (this can be adjusted
</I>&gt;&gt;<i> -later with an `update_fee` message).
</I>&gt;&gt;<i> +later with an `update_fee` message).&#160; Note that if
</I>&gt;&gt;<i> +`option_simplified_commitment` is negotiated, this `feerate_per_kw`
</I>&gt;&gt;<i> +is treated as 253 for all transactions.
</I>&gt;&gt;<i> &#160; `to_self_delay` is the number of blocks that the other node's to-self
</I>&gt;&gt;<i> &#160; outputs must be delayed, using `OP_CHECKSEQUENCEVERIFY` delays; this
</I>&gt;&gt;<i> @@ -208,7 +210,8 @@ The receiving node MUST fail the channel if:
</I>&gt;&gt;<i> &#160;&#160;&#160; - `push_msat` is greater than `funding_satoshis` * 1000.
</I>&gt;&gt;<i> &#160;&#160;&#160; - `to_self_delay` is unreasonably large.
</I>&gt;&gt;<i> &#160;&#160;&#160; - `max_accepted_htlcs` is greater than 483.
</I>&gt;&gt;<i> -&#160; - it considers `feerate_per_kw` too small for timely processing or 
</I>&gt;&gt;<i> unreasonably large.
</I>&gt;&gt;<i> +&#160; - if `option_simplified_commitment` is not negotiated:
</I>&gt;&gt;<i> +&#160;&#160;&#160; - it considers `feerate_per_kw` too small for timely processing 
</I>&gt;&gt;<i> or unreasonably large.
</I>&gt;&gt;<i> &#160;&#160;&#160; - `funding_pubkey`, `revocation_basepoint`, `htlc_basepoint`, 
</I>&gt;&gt;<i> `payment_basepoint`, or `delayed_payment_basepoint`
</I>&gt;&gt;<i> &#160; are not valid DER-encoded compressed secp256k1 pubkeys.
</I>&gt;&gt;<i> &#160;&#160;&#160; - `dust_limit_satoshis` is greater than `channel_reserve_satoshis`.
</I>&gt;&gt;<i> @@ -228,7 +231,7 @@ The *channel reserve* is specified by the peer's 
</I>&gt;&gt;<i> `channel_reserve_satoshis`: 1%
</I>&gt;&gt;<i> &#160; The sender can unconditionally give initial funds to the receiver 
</I>&gt;&gt;<i> using a non-zero `push_msat`, but even in this case we ensure that the 
</I>&gt;&gt;<i> funder has sufficient remaining funds to pay fees and that one side 
</I>&gt;&gt;<i> has some amount it can spend (which also implies there is at least one 
</I>&gt;&gt;<i> non-dust output). Note that, like any other on-chain transaction, this 
</I>&gt;&gt;<i> payment is not certain until the funding transaction has been 
</I>&gt;&gt;<i> confirmed sufficiently (with a danger of double-spend until this 
</I>&gt;&gt;<i> occurs) and may require a separate method to prove payment via 
</I>&gt;&gt;<i> on-chain confirmation.
</I>&gt;&gt;<i> -The `feerate_per_kw` is generally only of concern to the sender (who 
</I>&gt;&gt;<i> pays the fees), but there is also the fee rate paid by HTLC 
</I>&gt;&gt;<i> transactions; thus, unreasonably large fee rates can also penalize the 
</I>&gt;&gt;<i> recipient.
</I>&gt;&gt;<i> +The `feerate_per_kw` is generally only of concern to the sender (who 
</I>&gt;&gt;<i> pays the fees), but there is also the fee rate paid by HTLC 
</I>&gt;&gt;<i> transactions; thus, unreasonably large fee rates can also penalize the 
</I>&gt;&gt;<i> recipient.&#160; It is ignored for `option_simplified_commitment`.
</I>&gt;&gt;<i> &#160; Separating the `htlc_basepoint` from the `payment_basepoint` 
</I>&gt;&gt;<i> improves security: a node needs the secret associated with the 
</I>&gt;&gt;<i> `htlc_basepoint` to produce HTLC signatures for the protocol, but the 
</I>&gt;&gt;<i> secret for the `payment_basepoint` can be in cold storage.
</I>&gt;&gt;<i> @@ -340,6 +343,12 @@ This message introduces the `channel_id` to 
</I>&gt;&gt;<i> identify the channel. It's derived f
</I>&gt;&gt;<i> &#160; #### Requirements
</I>&gt;&gt;<i> +Both peers:
</I>&gt;&gt;<i> +&#160; - if `option_simplified_commitment` was negotiated:
</I>&gt;&gt;<i> +&#160;&#160;&#160; - `option_simplified_commitment` applies to all commitment and 
</I>&gt;&gt;<i> HTLC transactions
</I>&gt;&gt;<i> +&#160; - otherwise:
</I>&gt;&gt;<i> +&#160;&#160;&#160; - `option_simplified_commitment` does not apply to any commitment 
</I>&gt;&gt;<i> or HTLC transactions
</I>&gt;&gt;<i> +
</I>&gt;&gt;<i> &#160; The sender MUST set:
</I>&gt;&gt;<i> &#160;&#160;&#160; - `channel_id` by exclusive-OR of the `funding_txid` and the 
</I>&gt;&gt;<i> `funding_output_index` from the `funding_created` message.
</I>&gt;&gt;<i> &#160;&#160;&#160; - `signature` to the valid signature, using its `funding_pubkey` 
</I>&gt;&gt;<i> for the initial commitment transaction, as defined in [BOLT 
</I>&gt;&gt;<i> #3](03-transactions.md#commitment-transaction).
</I>&gt;&gt;<i> @@ -351,6 +360,12 @@ The recipient:
</I>&gt;&gt;<i> &#160;&#160;&#160; - on receipt of a valid `funding_signed`:
</I>&gt;&gt;<i> &#160;&#160;&#160;&#160;&#160; - SHOULD broadcast the funding transaction.
</I>&gt;&gt;<i> +#### Rationale
</I>&gt;&gt;<i> +
</I>&gt;&gt;<i> +We decide on `option_simplified_commitment` at this point when we 
</I>&gt;&gt;<i> first have to generate the commitment
</I>&gt;&gt;<i> +transaction.&#160; Even if a later reconnection does not negotiate this 
</I>&gt;&gt;<i> parameter, this channel will honor it.
</I>&gt;&gt;<i> +This simplifies channel state, particularly penalty transaction 
</I>&gt;&gt;<i> handling.
</I>&gt;&gt;<i> +
</I>&gt;&gt;<i> &#160; ### The `funding_locked` Message
</I>&gt;&gt;<i> &#160; This message indicates that the funding transaction has reached the 
</I>&gt;&gt;<i> `minimum_depth` asked for in `accept_channel`. Once both nodes have 
</I>&gt;&gt;<i> sent this, the channel enters normal operating mode.
</I>&gt;&gt;<i> @@ -508,8 +523,11 @@ The funding node:
</I>&gt;&gt;<i> &#160;&#160;&#160;&#160;&#160; - SHOULD send a `closing_signed` message.
</I>&gt;&gt;<i> &#160; The sending node:
</I>&gt;&gt;<i> -&#160; - MUST set `fee_satoshis` less than or equal to the
</I>&gt;&gt;<i> - base fee of the final commitment transaction, as calculated in [BOLT 
</I>&gt;&gt;<i> #3](03-transactions.md#fee-calculation).
</I>&gt;&gt;<i> +&#160; - if `option_upfront_shutdown_script` applies to the final 
</I>&gt;&gt;<i> commitment transaction:
</I>&gt;&gt;<i> +&#160;&#160;&#160; - MUST set `fee_satoshis` greater than or equal to 282.
</I>&gt;&gt;<i> +&#160; - otherwise:
</I>&gt;&gt;<i> +&#160;&#160;&#160; - MUST set `fee_satoshis` less than or equal to the
</I>&gt;&gt;<i> +&#160;&#160;&#160;&#160;&#160; base fee of the final commitment transaction, as calculated in 
</I>&gt;&gt;<i> [BOLT #3](03-transactions.md#fee-calculation).
</I>&gt;&gt;<i> &#160;&#160;&#160; - SHOULD set the initial `fee_satoshis` according to its
</I>&gt;&gt;<i> &#160;&#160; estimate of cost of inclusion in a block.
</I>&gt;&gt;<i> &#160;&#160;&#160; - MUST set `signature` to the Bitcoin signature of the close
</I>&gt;&gt;<i> @@ -543,9 +561,18 @@ progress is made, even if only by a single 
</I>&gt;&gt;<i> satoshi at a time. To avoid
</I>&gt;&gt;<i> &#160; keeping state and to handle the corner case, where fees have shifted
</I>&gt;&gt;<i> &#160; between disconnection and reconnection, negotiation restarts on 
</I>&gt;&gt;<i> reconnection.
</I>&gt;&gt;<i> -Note there is limited risk if the closing transaction is
</I>&gt;&gt;<i> -delayed, but it will be broadcast very soon; so there is usually no
</I>&gt;&gt;<i> -reason to pay a premium for rapid processing.
</I>&gt;&gt;<i> +In the `option_simplified_commitment` case, the fees on the commitment
</I>&gt;&gt;<i> +transaction itself are minimal (it is assumed that a child 
</I>&gt;&gt;<i> transaction will
</I>&gt;&gt;<i> +supply additional fee incentive), so that forms a floor for negotiation.
</I>&gt;&gt;<i> +[BOLT #3](03-transactions.md#fee-calculation), gives 282 satoshis (1116
</I>&gt;&gt;<i> +weight, 254 `feerate_per_kw`).
</I>&gt;&gt;<i> +
</I>&gt;&gt;<i> +Otherwise, the commitment transaction usually pays a premium fee, so 
</I>&gt;&gt;<i> that
</I>&gt;&gt;<i> +forms a ceiling.
</I>&gt;&gt;<i> +
</I>&gt;&gt;<i> +Note there is limited risk if the closing transaction is delayed, but 
</I>&gt;&gt;<i> it will
</I>&gt;&gt;<i> +be broadcast very soon; so there is usually no reason to pay a 
</I>&gt;&gt;<i> premium for
</I>&gt;&gt;<i> +rapid processing.
</I>&gt;&gt;<i> &#160; ## Normal Operation
</I>&gt;&gt;<i> @@ -763,7 +790,10 @@ is destined, is described in [BOLT 
</I>&gt;&gt;<i> #4](04-onion-routing.md).
</I>&gt;&gt;<i> &#160; A sending node:
</I>&gt;&gt;<i> &#160;&#160;&#160; - MUST NOT offer `amount_msat` it cannot pay for in the
</I>&gt;&gt;<i> &#160; remote commitment transaction at the current `feerate_per_kw` (see 
</I>&gt;&gt;<i> &quot;Updating
</I>&gt;&gt;<i> -Fees&quot;) while maintaining its channel reserve.
</I>&gt;&gt;<i> +Fees&quot;) while maintaining its channel reserve
</I>&gt;&gt;<i> +&#160; - if `option_simplified_commitment` applies to this commitment 
</I>&gt;&gt;<i> transaction and the sending
</I>&gt;&gt;<i> +&#160;&#160;&#160; node is the funder:
</I>&gt;&gt;<i> +&#160;&#160;&#160; - MUST be able to additionally pay for `to_local_pushme` and 
</I>&gt;&gt;<i> `to_remote_pushme` above its reserve.
</I>&gt;&gt;<i> &#160;&#160;&#160; - MUST offer `amount_msat` greater than 0.
</I>&gt;&gt;<i> &#160;&#160;&#160; - MUST NOT offer `amount_msat` below the receiving node's 
</I>&gt;&gt;<i> `htlc_minimum_msat`
</I>&gt;&gt;<i> &#160;&#160;&#160; - MUST set `cltv_expiry` less than 500000000.
</I>&gt;&gt;<i> @@ -782,7 +812,7 @@ Fees&quot;) while maintaining its channel reserve.
</I>&gt;&gt;<i> &#160; A receiving node:
</I>&gt;&gt;<i> &#160;&#160;&#160; - receiving an `amount_msat` equal to 0, OR less than its own 
</I>&gt;&gt;<i> `htlc_minimum_msat`:
</I>&gt;&gt;<i> &#160;&#160;&#160;&#160;&#160; - SHOULD fail the channel.
</I>&gt;&gt;<i> -&#160; - receiving an `amount_msat` that the sending node cannot afford at 
</I>&gt;&gt;<i> the current `feerate_per_kw` (while maintaining its channel reserve):
</I>&gt;&gt;<i> +&#160; - receiving an `amount_msat` that the sending node cannot afford at 
</I>&gt;&gt;<i> the current `feerate_per_kw` (while maintaining its channel reserve 
</I>&gt;&gt;<i> and any `to_local_pushme` and `to_remote_pushme` fees):
</I>&gt;&gt;<i> &#160;&#160;&#160;&#160;&#160; - SHOULD fail the channel.
</I>&gt;&gt;<i> &#160;&#160;&#160; - if a sending node adds more than its `max_accepted_htlcs` HTLCs to
</I>&gt;&gt;<i> &#160;&#160;&#160;&#160;&#160; its local commitment transaction, OR adds more than its 
</I>&gt;&gt;<i> `max_htlc_value_in_flight_msat` worth of offered HTLCs to its local 
</I>&gt;&gt;<i> commitment transaction:
</I>&gt;&gt;<i> @@ -997,6 +1027,11 @@ A node:
</I>&gt;&gt;<i> &#160; ### Updating Fees: `update_fee`
</I>&gt;&gt;<i> +If `option_simplified_commitment` applies to the commitment transaction,
</I>&gt;&gt;<i> +`update_fee` is never used: the `feerate_per_kw` is always considered 
</I>&gt;&gt;<i> 253, but
</I>&gt;&gt;<i> +the funder also pays 2000 satoshi for the `to_local_pushme` and
</I>&gt;&gt;<i> +`to_remote_pushme` outputs.
</I>&gt;&gt;<i> +
</I>&gt;&gt;<i> &#160; An `update_fee` message is sent by the node which is paying the
</I>&gt;&gt;<i> &#160; Bitcoin fee. Like any update, it's first committed to the receiver's
</I>&gt;&gt;<i> &#160; commitment transaction and then (once acknowledged) committed to the
</I>&gt;&gt;<i> @@ -1020,13 +1055,19 @@ given in [BOLT 
</I>&gt;&gt;<i> #3](03-transactions.md#fee-calculation).
</I>&gt;&gt;<i> &#160; #### Requirements
</I>&gt;&gt;<i> &#160; The node _responsible_ for paying the Bitcoin fee:
</I>&gt;&gt;<i> -&#160; - SHOULD send `update_fee` to ensure the current fee rate is 
</I>&gt;&gt;<i> sufficient (by a
</I>&gt;&gt;<i> +&#160; - if `option_simplified_commitment` applies to the commitment 
</I>&gt;&gt;<i> transaction:
</I>&gt;&gt;<i> +&#160;&#160;&#160; - MUST NOT send `update_fee`.
</I>&gt;&gt;<i> +&#160; - otherwise:
</I>&gt;&gt;<i> +&#160;&#160;&#160; - SHOULD send `update_fee` to ensure the current fee rate is 
</I>&gt;&gt;<i> sufficient (by a
</I>&gt;&gt;<i> &#160;&#160;&#160;&#160;&#160;&#160;&#160; significant margin) for timely processing of the commitment 
</I>&gt;&gt;<i> transaction.
</I>&gt;&gt;<i> &#160; The node _not responsible_ for paying the Bitcoin fee:
</I>&gt;&gt;<i> &#160;&#160;&#160; - MUST NOT send `update_fee`.
</I>&gt;&gt;<i> &#160; A receiving node:
</I>&gt;&gt;<i> +&#160; - if `option_simplified_commitment` applies to the commitment 
</I>&gt;&gt;<i> transaction:
</I>&gt;&gt;<i> +&#160;&#160;&#160; - SHOULD fail the channel.
</I>&gt;&gt;<i> +&#160;&#160;&#160; - MUST NOT update the `feerate_per_kw`.
</I>&gt;&gt;<i> &#160;&#160;&#160; - if the `update_fee` is too low for timely processing, OR is 
</I>&gt;&gt;<i> unreasonably large:
</I>&gt;&gt;<i> &#160;&#160;&#160;&#160;&#160; - SHOULD fail the channel.
</I>&gt;&gt;<i> &#160;&#160;&#160; - if the sender is not responsible for paying the Bitcoin fee:
</I>&gt;&gt;<i> @@ -1038,7 +1079,12 @@ A receiving node:
</I>&gt;&gt;<i> &#160; #### Rationale
</I>&gt;&gt;<i> -Bitcoin fees are required for unilateral closes to be effective &#8212;
</I>&gt;&gt;<i> +Fee adjustments are unnecessary for `option_simplified_commitment` which
</I>&gt;&gt;<i> +relies on &quot;pushme&quot; outputs and a child transaction which will provide
</I>&gt;&gt;<i> +additional fee incentive which can be calculated at the time it is 
</I>&gt;&gt;<i> spent, and
</I>&gt;&gt;<i> +replaced by higher-fee children if required.
</I>&gt;&gt;<i> +
</I>&gt;&gt;<i> +Without this option, bitcoin fees are required for unilateral closes 
</I>&gt;&gt;<i> to be effective &#8212;
</I>&gt;&gt;<i> &#160; particularly since there is no general method for the broadcasting 
</I>&gt;&gt;<i> node to use
</I>&gt;&gt;<i> &#160; child-pays-for-parent to increase its effective fee.
</I>&gt;&gt;<i> diff --git a/03-transactions.md b/03-transactions.md
</I>&gt;&gt;<i> index e769961..440bd0d 100644
</I>&gt;&gt;<i> --- a/03-transactions.md
</I>&gt;&gt;<i> +++ b/03-transactions.md
</I>&gt;&gt;<i> @@ -82,6 +82,8 @@ To allow an opportunity for penalty transactions, in 
</I>&gt;&gt;<i> case of a revoked commitmen
</I>&gt;&gt;<i> &#160; The reason for the separate transaction stage for HTLC outputs is so 
</I>&gt;&gt;<i> that HTLCs can timeout or be fulfilled even though they are within the 
</I>&gt;&gt;<i> `to_self_delay` delay.
</I>&gt;&gt;<i> &#160; Otherwise, the required minimum timeout on HTLCs is lengthened by 
</I>&gt;&gt;<i> this delay, causing longer timeouts for HTLCs traversing the network.
</I>&gt;&gt;<i> +If `option_simplified_commitment` applies to the commitment 
</I>&gt;&gt;<i> transaction, then the `to_self_delay` used for all transactions is the 
</I>&gt;&gt;<i> greater of the `to_self_delay` sent by each peer.&#160; Otherwise, each 
</I>&gt;&gt;<i> peer sends the `to_self_delay` to be used for the other peer's 
</I>&gt;&gt;<i> commitment amd HTLC transactions.
</I>&gt;&gt;<i> +
</I>&gt;&gt;<i> &#160; The amounts for each output MUST be rounded down to whole satoshis. 
</I>&gt;&gt;<i> If this amount, minus the fees for the HTLC transaction, is less than 
</I>&gt;&gt;<i> the `dust_limit_satoshis` set by the owner of the commitment 
</I>&gt;&gt;<i> transaction, the output MUST NOT be produced (thus the funds add to 
</I>&gt;&gt;<i> fees).
</I>&gt;&gt;<i> &#160; #### `to_local` Output
</I>&gt;&gt;<i> @@ -109,7 +111,40 @@ If a revoked commitment transaction is published, 
</I>&gt;&gt;<i> the other party can spend this
</I>&gt;&gt;<i> &#160; #### `to_remote` Output
</I>&gt;&gt;<i> -This output sends funds to the other peer and thus is a simple P2WPKH 
</I>&gt;&gt;<i> to `remotepubkey`.
</I>&gt;&gt;<i> +This output sends funds to the other peer, thus is not encumbered by a
</I>&gt;&gt;<i> +revocation private key.
</I>&gt;&gt;<i> +
</I>&gt;&gt;<i> +If `option_simplified_commitment` applies to the commitment 
</I>&gt;&gt;<i> transaction, the `to_remote` output is delayed similarly to the 
</I>&gt;&gt;<i> `to_local` output, and is to a fixed key:
</I>&gt;&gt;<i> +
</I>&gt;&gt;<i> +&#160;&#160;&#160;&#160;&#160;&#160;&#160; `to_self_delay`
</I>&gt;&gt;<i> +&#160;&#160;&#160;&#160;&#160;&#160;&#160; OP_CSV
</I>&gt;&gt;<i> +&#160;&#160;&#160;&#160;&#160;&#160;&#160; OP_DROP
</I>&gt;&gt;<i> +&#160;&#160;&#160;&#160;&#160;&#160;&#160; &lt;remote_pubkey&gt;
</I>&gt;&gt;<i> +
</I>&gt;&gt;<i> +The output is spent by a transaction with `nSequence` field set to 
</I>&gt;&gt;<i> `to_self_delay` (which can only be valid after that duration has 
</I>&gt;&gt;<i> passed) and witness:
</I>&gt;&gt;<i> +
</I>&gt;&gt;<i> +&#160;&#160;&#160; &lt;remote_sig&gt;
</I>&gt;&gt;<i> +
</I>&gt;&gt;<i> +Otherwise, this output is a simple P2WPKH to `remotepubkey`.
</I>&gt;&gt;<i> +
</I>&gt;&gt;<i> +
</I>&gt;&gt;<i> +#### `to_local_pushme` and `to_remote_pushme` Output 
</I>&gt;&gt;<i> (option_simplified_commitment)
</I>&gt;&gt;<i> +
</I>&gt;&gt;<i> +This output can be spent by the local and remote nodes respectivey to 
</I>&gt;&gt;<i> provide incentive to mine the transaction, using 
</I>&gt;&gt;<i> child-pays-for-parent.&#160; They are only added if the `to_local` and 
</I>&gt;&gt;<i> `to_remote` outputs exist, respectively.
</I>&gt;&gt;<i> +
</I>&gt;&gt;<i> +&#160;&#160;&#160; OP_DEPTH
</I>&gt;&gt;<i> +&#160;&#160;&#160; OP_IF
</I>&gt;&gt;<i> +&#160;&#160;&#160;&#160;&#160;&#160;&#160; &lt;pubkey&gt; OP_CHECKSIG
</I>&gt;&gt;<i> +&#160;&#160;&#160; OP_ELSE
</I>&gt;&gt;<i> +&#160;&#160;&#160;&#160;&#160;&#160;&#160; 10 OP_CSV
</I>&gt;&gt;<i> +&#160;&#160;&#160; OP_ENDIF
</I>&gt;&gt;<i> +
</I>&gt;&gt;<i> +The `&lt;pubkey&gt;` is `&lt;local_delayedpubkey&gt;` to `to_local_pushme` and
</I>&gt;&gt;<i> +`&lt;remote_delayedpubkey&gt;` for `to_remote_pushme`.&#160; The output amount is
</I>&gt;&gt;<i> +1000 satoshi, to encourage spending of the output.&#160; Once the
</I>&gt;&gt;<i> +`remote_pubkey` is revealed (by spending the `to_local` output) and
</I>&gt;&gt;<i> +the commitment transaction is 10 blocks deep, anyone can spend it.
</I>&gt;&gt;<i> +
</I>&gt;&gt;<i> &#160; #### Offered HTLC Outputs
</I>&gt;&gt;<i> @@ -294,6 +329,9 @@ The fee calculation for both commitment 
</I>&gt;&gt;<i> transactions and HTLC
</I>&gt;&gt;<i> &#160; transactions is based on the current `feerate_per_kw` and the
</I>&gt;&gt;<i> &#160; *expected weight* of the transaction.
</I>&gt;&gt;<i> +Note that if `option_simplified_commitment` applies to the commitment
</I>&gt;&gt;<i> +transaction then `feerate_per_kw` is 253.
</I>&gt;&gt;<i> +
</I>&gt;&gt;<i> &#160; The actual and expected weights vary for several reasons:
</I>&gt;&gt;<i> &#160; * Bitcoin uses DER-encoded signatures, which vary in size.
</I>&gt;&gt;<i> @@ -306,10 +344,12 @@ Thus, a simplified formula for *expected weight* 
</I>&gt;&gt;<i> is used, which assumes:
</I>&gt;&gt;<i> &#160; * Signatures are 73 bytes long (the maximum length).
</I>&gt;&gt;<i> &#160; * There are a small number of outputs (thus 1 byte to count them).
</I>&gt;&gt;<i> &#160; * There are always both a `to_local` output and a `to_remote` output.
</I>&gt;&gt;<i> +* (if `option_simplified_commitment`) there are always both a 
</I>&gt;&gt;<i> `to_local_pushme` and `to_remote_pushme` output.
</I>&gt;&gt;<i> &#160; This yields the following *expected weights* (details of the 
</I>&gt;&gt;<i> computation in [Appendix A](#appendix-a-expected-weights)):
</I>&gt;&gt;<i> -&#160;&#160;&#160; Commitment weight:&#160;&#160; 724 + 172 * num-untrimmed-htlc-outputs
</I>&gt;&gt;<i> +&#160;&#160;&#160; Commitment weight (no option_simplified_commitment):&#160;&#160; 724 + 172 
</I>&gt;&gt;<i> * num-untrimmed-htlc-outputs
</I>&gt;&gt;<i> +&#160;&#160;&#160; Commitment weight (option_simplified_commitment:&#160; 1116 + 172 * 
</I>&gt;&gt;<i> num-untrimmed-htlc-outputs
</I>&gt;&gt;<i> &#160;&#160;&#160;&#160;&#160; HTLC-timeout weight: 663
</I>&gt;&gt;<i> &#160;&#160;&#160;&#160;&#160; HTLC-success weight: 703
</I>&gt;&gt;<i> @@ -366,7 +406,7 @@ outputs) is 7140 satoshi. The final fee may be 
</I>&gt;&gt;<i> even higher if the
</I>&gt;&gt;<i> &#160; ### Fee Payment
</I>&gt;&gt;<i> -Base commitment transaction fees are extracted from the funder's 
</I>&gt;&gt;<i> amount; if that amount is insufficient, the entire amount of the 
</I>&gt;&gt;<i> funder's output is used.
</I>&gt;&gt;<i> +Base commitment transaction fees and amounts for `to_local_pushme` 
</I>&gt;&gt;<i> and `to_remote_pushme` outputs are extracted from the funder's amount; 
</I>&gt;&gt;<i> if that amount is insufficient, the entire amount of the funder's 
</I>&gt;&gt;<i> output is used.
</I>&gt;&gt;<i> &#160; Note that after the fee amount is subtracted from the to-funder output,
</I>&gt;&gt;<i> &#160; that output may be below `dust_limit_satoshis`, and thus will also
</I>&gt;&gt;<i> @@ -390,23 +430,29 @@ committed HTLCs:
</I>&gt;&gt;<i> &#160; 2. Calculate the base [commitment transaction fee](#fee-calculation).
</I>&gt;&gt;<i> &#160; 3. Subtract this base fee from the funder (either `to_local` or 
</I>&gt;&gt;<i> `to_remote`),
</I>&gt;&gt;<i> &#160;&#160;&#160;&#160; with a floor of 0 (see [Fee Payment](#fee-payment)).
</I>&gt;&gt;<i> +4. If `option_simplified_commitment` applies to the commitment 
</I>&gt;&gt;<i> transaction,
</I>&gt;&gt;<i> +&#160;&#160; subtract 2000 satoshis from the funder (either `to_local` or 
</I>&gt;&gt;<i> `to_remote`).
</I>&gt;&gt;<i> &#160; 3. For every offered HTLC, if it is not trimmed, add an
</I>&gt;&gt;<i> &#160;&#160;&#160;&#160; [offered HTLC output](#offered-htlc-outputs).
</I>&gt;&gt;<i> &#160; 4. For every received HTLC, if it is not trimmed, add an
</I>&gt;&gt;<i> &#160;&#160;&#160;&#160; [received HTLC output](#received-htlc-outputs).
</I>&gt;&gt;<i> &#160; 5. If the `to_local` amount is greater or equal to 
</I>&gt;&gt;<i> `dust_limit_satoshis`,
</I>&gt;&gt;<i> &#160;&#160;&#160;&#160; add a [`to_local` output](#to_local-output).
</I>&gt;&gt;<i> +6. If `option_simplified_commitment` applies to the commitment 
</I>&gt;&gt;<i> transaction,
</I>&gt;&gt;<i> +&#160;&#160; and `to_local` was added, add `to_local_pushme`.
</I>&gt;&gt;<i> &#160; 6. If the `to_remote` amount is greater or equal to 
</I>&gt;&gt;<i> `dust_limit_satoshis`,
</I>&gt;&gt;<i> &#160;&#160;&#160;&#160; add a [`to_remote` output](#to_remote-output).
</I>&gt;&gt;<i> +6. If `option_simplified_commitment` applies to the commitment 
</I>&gt;&gt;<i> transaction,
</I>&gt;&gt;<i> +&#160;&#160; and `to_remote` was added, add `to_remote_pushme`.
</I>&gt;&gt;<i> &#160; 7. Sort the outputs into [BIP 69 
</I>&gt;&gt;<i> order](#transaction-input-and-output-ordering).
</I>&gt;&gt;<i> &#160; # Keys
</I>&gt;&gt;<i> &#160; ## Key Derivation
</I>&gt;&gt;<i> -Each commitment transaction uses a unique set of keys: `localpubkey` 
</I>&gt;&gt;<i> and `remotepubkey`.
</I>&gt;&gt;<i> +Each commitment transaction uses a unique `localpubkey`, and a 
</I>&gt;&gt;<i> `remotepubkey`.
</I>&gt;&gt;<i> &#160; The HTLC-success and HTLC-timeout transactions use 
</I>&gt;&gt;<i> `local_delayedpubkey` and `revocationpubkey`.
</I>&gt;&gt;<i> -These are changed for every transaction based on the 
</I>&gt;&gt;<i> `per_commitment_point`.
</I>&gt;&gt;<i> +These are changed for every transaction based on the 
</I>&gt;&gt;<i> `per_commitment_point`, with the exception of `remotepubkey` if 
</I>&gt;&gt;<i> `option_simplified_commitment` is negotiated.
</I>&gt;&gt;<i> &#160; The reason for key change is so that trustless watching for revoked
</I>&gt;&gt;<i> &#160; transactions can be outsourced. Such a _watcher_ should not be able to
</I>&gt;&gt;<i> @@ -419,8 +465,9 @@ avoid storage of every commitment transaction, a 
</I>&gt;&gt;<i> _watcher_ can be given the
</I>&gt;&gt;<i> &#160; the scripts required for the penalty transaction; thus, a _watcher_ 
</I>&gt;&gt;<i> need only be
</I>&gt;&gt;<i> &#160; given (and store) the signatures for each penalty input.
</I>&gt;&gt;<i> -Changing the `localpubkey` and `remotepubkey` every time ensures that 
</I>&gt;&gt;<i> commitment
</I>&gt;&gt;<i> -transaction ID cannot be guessed; every commitment transaction uses 
</I>&gt;&gt;<i> an ID
</I>&gt;&gt;<i> +Changing the `localpubkey` every time ensures that commitment
</I>&gt;&gt;<i> +transaction ID cannot be guessed except in the trivial case where 
</I>&gt;&gt;<i> there is no
</I>&gt;&gt;<i> +`to_local` output, as every commitment transaction uses an ID
</I>&gt;&gt;<i> &#160; in its output script. Splitting the `local_delayedpubkey`, which is 
</I>&gt;&gt;<i> required for
</I>&gt;&gt;<i> &#160; the penalty transaction, allows it to be shared with the _watcher_ 
</I>&gt;&gt;<i> without
</I>&gt;&gt;<i> &#160; revealing `localpubkey`; even if both peers use the same _watcher_, 
</I>&gt;&gt;<i> nothing is revealed.
</I>&gt;&gt;<i> @@ -434,14 +481,13 @@ For efficiency, keys are generated from a series 
</I>&gt;&gt;<i> of per-commitment secrets
</I>&gt;&gt;<i> &#160; that are generated from a single seed, which allows the receiver to 
</I>&gt;&gt;<i> compactly
</I>&gt;&gt;<i> &#160; store them (see [below](#efficient-per-commitment-secret-storage)).
</I>&gt;&gt;<i> -### `localpubkey`, `remotepubkey`, `local_htlcpubkey`, 
</I>&gt;&gt;<i> `remote_htlcpubkey`, `local_delayedpubkey`, and `remote_delayedpubkey` 
</I>&gt;&gt;<i> Derivation
</I>&gt;&gt;<i> +### `localpubkey``local_htlcpubkey`, `remote_htlcpubkey`, 
</I>&gt;&gt;<i> `local_delayedpubkey`, and `remote_delayedpubkey` Derivation
</I>&gt;&gt;<i> &#160; These pubkeys are simply generated by addition from their base points:
</I>&gt;&gt;<i> &#160;&#160;&#160;&#160;&#160; pubkey = basepoint + SHA256(per_commitment_point || basepoint) * G
</I>&gt;&gt;<i> -The `localpubkey` uses the local node's `payment_basepoint`; the 
</I>&gt;&gt;<i> `remotepubkey`
</I>&gt;&gt;<i> -uses the remote node's `payment_basepoint`; the `local_delayedpubkey`
</I>&gt;&gt;<i> +The `localpubkey` uses the local node's `payment_basepoint`; the 
</I>&gt;&gt;<i> `local_delayedpubkey`
</I>&gt;&gt;<i> &#160; uses the local node's `delayed_payment_basepoint`; the 
</I>&gt;&gt;<i> `local_htlcpubkey` uses the
</I>&gt;&gt;<i> &#160; local node's `htlc_basepoint`; and the `remote_delayedpubkey` uses 
</I>&gt;&gt;<i> the remote
</I>&gt;&gt;<i> &#160; node's `delayed_payment_basepoint`.
</I>&gt;&gt;<i> @@ -451,6 +497,17 @@ secrets are known (i.e. the private keys 
</I>&gt;&gt;<i> corresponding to `localpubkey`, `local_
</I>&gt;&gt;<i> &#160;&#160;&#160;&#160;&#160; privkey = basepoint_secret + SHA256(per_commitment_point || 
</I>&gt;&gt;<i> basepoint)
</I>&gt;&gt;<i> +### `remotepubkey` Derivation
</I>&gt;&gt;<i> +
</I>&gt;&gt;<i> +If `option_simplified_commitment` is negotiated the `remotepubkey` is 
</I>&gt;&gt;<i> simply the remote node's `payment_basepoint`, otherwise it is 
</I>&gt;&gt;<i> calculated as above using the remote node's `payment_basepoint`.
</I>&gt;&gt;<i> +
</I>&gt;&gt;<i> +The simplified derivation means that a node can spend a commitment
</I>&gt;&gt;<i> +transaction even if it has lost data and doesn't know the
</I>&gt;&gt;<i> +corresponding `payment_basepoint`.&#160; A watchtower could correlate
</I>&gt;&gt;<i> +transactions given to it which only have a `to_remote` output if it
</I>&gt;&gt;<i> +sees one of them onchain, but such transactions do not need any
</I>&gt;&gt;<i> +enforcement and should not be handed to a watchtower.
</I>&gt;&gt;<i> +
</I>&gt;&gt;<i> &#160; ### `revocationpubkey` Derivation
</I>&gt;&gt;<i> &#160; The `revocationpubkey` is a blinded key: when the local node wishes 
</I>&gt;&gt;<i> to create a new
</I>&gt;&gt;<i> @@ -636,12 +693,22 @@ The *expected weight* of a commitment 
</I>&gt;&gt;<i> transaction is calculated as follows:
</I>&gt;&gt;<i> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; - var_int: 1 byte (pk_script length)
</I>&gt;&gt;<i> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; - pk_script (p2wsh): 34 bytes
</I>&gt;&gt;<i> -&#160;&#160;&#160; output_paying_to_remote: 31 bytes
</I>&gt;&gt;<i> +&#160;&#160;&#160; output_paying_to_remote (no option_simplified_commitment): 31 bytes
</I>&gt;&gt;<i> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; - value: 8 bytes
</I>&gt;&gt;<i> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; - var_int: 1 byte (pk_script length)
</I>&gt;&gt;<i> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; - pk_script (p2wpkh): 22 bytes
</I>&gt;&gt;<i> -&#160;&#160;&#160;&#160; htlc_output: 43 bytes
</I>&gt;&gt;<i> +&#160;&#160;&#160; output_paying_to_remote (option_simplified_commitment): 43 bytes
</I>&gt;&gt;<i> +&#160;&#160;&#160;&#160;&#160;&#160;&#160; - value: 8 bytes
</I>&gt;&gt;<i> +&#160;&#160;&#160;&#160;&#160;&#160;&#160; - var_int: 1 byte (pk_script length)
</I>&gt;&gt;<i> +&#160;&#160;&#160;&#160;&#160;&#160;&#160; - pk_script (p2wsh): 34 bytes
</I>&gt;&gt;<i> +
</I>&gt;&gt;<i> +&#160;&#160;&#160; output_pushme (option_simplified_commitment): 43 bytes
</I>&gt;&gt;<i> +&#160;&#160;&#160;&#160;&#160;&#160;&#160; - value: 8 bytes
</I>&gt;&gt;<i> +&#160;&#160;&#160;&#160;&#160;&#160;&#160; - var_int: 1 byte (pk_script length)
</I>&gt;&gt;<i> +&#160;&#160;&#160;&#160;&#160;&#160;&#160; - pk_script (p2wsh): 34 bytes
</I>&gt;&gt;<i> +
</I>&gt;&gt;<i> +&#160;&#160;&#160; htlc_output: 43 bytes
</I>&gt;&gt;<i> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; - value: 8 bytes
</I>&gt;&gt;<i> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; - var_int: 1 byte (pk_script length)
</I>&gt;&gt;<i> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; - pk_script (p2wsh): 34 bytes
</I>&gt;&gt;<i> @@ -650,7 +717,7 @@ The *expected weight* of a commitment transaction 
</I>&gt;&gt;<i> is calculated as follows:
</I>&gt;&gt;<i> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; - flag: 1 byte
</I>&gt;&gt;<i> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; - marker: 1 byte
</I>&gt;&gt;<i> -&#160;&#160;&#160;&#160; commitment_transaction: 125 + 43 * num-htlc-outputs bytes
</I>&gt;&gt;<i> +&#160;&#160;&#160;&#160; commitment_transaction (no option_simplified_commitment): 125 + 
</I>&gt;&gt;<i> 43 * num-htlc-outputs bytes
</I>&gt;&gt;<i> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; - version: 4 bytes
</I>&gt;&gt;<i> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; - witness_header &lt;---- part of the witness data
</I>&gt;&gt;<i> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; - count_tx_in: 1 byte
</I>&gt;&gt;<i> @@ -663,15 +730,32 @@ The *expected weight* of a commitment 
</I>&gt;&gt;<i> transaction is calculated as follows:
</I>&gt;&gt;<i> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; ....htlc_output's...
</I>&gt;&gt;<i> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; - lock_time: 4 bytes
</I>&gt;&gt;<i> +&#160;&#160;&#160;&#160; commitment_transaction (option_simplified_commitment): 223 + 43 
</I>&gt;&gt;<i> * num-htlc-outputs bytes
</I>&gt;&gt;<i> +&#160;&#160;&#160;&#160;&#160;&#160;&#160; - version: 4 bytes
</I>&gt;&gt;<i> +&#160;&#160;&#160;&#160;&#160;&#160;&#160; - witness_header &lt;---- part of the witness data
</I>&gt;&gt;<i> +&#160;&#160;&#160;&#160;&#160;&#160;&#160; - count_tx_in: 1 byte
</I>&gt;&gt;<i> +&#160;&#160;&#160;&#160;&#160;&#160;&#160; - tx_in: 41 bytes
</I>&gt;&gt;<i> +&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; funding_input
</I>&gt;&gt;<i> +&#160;&#160;&#160;&#160;&#160;&#160;&#160; - count_tx_out: 1 byte
</I>&gt;&gt;<i> +&#160;&#160;&#160;&#160;&#160;&#160;&#160; - tx_out: 172 + 43 * num-htlc-outputs bytes
</I>&gt;&gt;<i> +&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; output_paying_to_remote,
</I>&gt;&gt;<i> +&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; output_paying_to_local,
</I>&gt;&gt;<i> +&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; output_pushme,
</I>&gt;&gt;<i> +&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; output_pushme,
</I>&gt;&gt;<i> +&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; ....htlc_output's...
</I>&gt;&gt;<i> +&#160;&#160;&#160;&#160;&#160;&#160;&#160; - lock_time: 4 bytes
</I>&gt;&gt;<i> +
</I>&gt;&gt;<i> &#160; Multiplying non-witness data by 4 results in a weight of:
</I>&gt;&gt;<i> -&#160;&#160;&#160; // 500 + 172 * num-htlc-outputs weight
</I>&gt;&gt;<i> +&#160;&#160;&#160; // 500 + 172 * num-htlc-outputs weight (no 
</I>&gt;&gt;<i> option_simplified_commitment)
</I>&gt;&gt;<i> +&#160;&#160;&#160; // 892 + 172 * num-htlc-outputs weight 
</I>&gt;&gt;<i> (option_simplified_commitment)
</I>&gt;&gt;<i> &#160;&#160;&#160;&#160;&#160; commitment_transaction_weight = 4 * commitment_transaction
</I>&gt;&gt;<i> &#160;&#160;&#160;&#160;&#160; // 224 weight
</I>&gt;&gt;<i> &#160;&#160;&#160;&#160;&#160; witness_weight = witness_header + witness
</I>&gt;&gt;<i> -&#160;&#160;&#160; overall_weight = 500 + 172 * num-htlc-outputs + 224 weight
</I>&gt;&gt;<i> +&#160;&#160;&#160; overall_weight (no option_simplified_commitment) = 500 + 172 * 
</I>&gt;&gt;<i> num-htlc-outputs + 224 weight
</I>&gt;&gt;<i> +&#160;&#160;&#160; overall_weight (option_simplified_commitment) = 892 + 172 * 
</I>&gt;&gt;<i> num-htlc-outputs + 224 weight
</I>&gt;&gt;<i> &#160; ## Expected Weight of HTLC-timeout and HTLC-success Transactions
</I>&gt;&gt;<i> diff --git a/05-onchain.md b/05-onchain.md
</I>&gt;&gt;<i> index 231c209..c5fb5e1 100644
</I>&gt;&gt;<i> --- a/05-onchain.md
</I>&gt;&gt;<i> +++ b/05-onchain.md
</I>&gt;&gt;<i> @@ -89,21 +89,29 @@ trigger any action.
</I>&gt;&gt;<i> &#160; # Commitment Transaction
</I>&gt;&gt;<i> &#160; The local and remote nodes each hold a *commitment transaction*. 
</I>&gt;&gt;<i> Each of these
</I>&gt;&gt;<i> -commitment transactions has four types of outputs:
</I>&gt;&gt;<i> +commitment transactions has six types of outputs:
</I>&gt;&gt;<i> &#160; 1. _local node's main output_: Zero or one output, to pay to the 
</I>&gt;&gt;<i> *local node's*
</I>&gt;&gt;<i> -commitment pubkey.
</I>&gt;&gt;<i> +delayed pubkey.
</I>&gt;&gt;<i> &#160; 2. _remote node's main output_: Zero or one output, to pay to the 
</I>&gt;&gt;<i> *remote node's*
</I>&gt;&gt;<i> -commitment pubkey.
</I>&gt;&gt;<i> +pubkey.
</I>&gt;&gt;<i> +1. _local node's push output_: Zero or one output, to pay to the 
</I>&gt;&gt;<i> *local node's*
</I>&gt;&gt;<i> +delayed pubkey.
</I>&gt;&gt;<i> +2. _remote node's push output_: Zero or one output, to pay to the 
</I>&gt;&gt;<i> *remote node's*
</I>&gt;&gt;<i> +pubkey.
</I>&gt;&gt;<i> &#160; 3. _local node's offered HTLCs_: Zero or more pending payments 
</I>&gt;&gt;<i> (*HTLCs*), to pay
</I>&gt;&gt;<i> &#160; the *remote node* in return for a payment preimage.
</I>&gt;&gt;<i> &#160; 4. _remote node's offered HTLCs_: Zero or more pending payments 
</I>&gt;&gt;<i> (*HTLCs*), to
</I>&gt;&gt;<i> &#160; pay the *local node* in return for a payment preimage.
</I>&gt;&gt;<i> &#160; To incentivize the local and remote nodes to cooperate, an 
</I>&gt;&gt;<i> `OP_CHECKSEQUENCEVERIFY`
</I>&gt;&gt;<i> -relative timeout encumbers the *local node's outputs* (in the *local 
</I>&gt;&gt;<i> node's
</I>&gt;&gt;<i> +relative timeout encumbers some outputs: the *local node's outputs* 
</I>&gt;&gt;<i> (in the *local node's
</I>&gt;&gt;<i> &#160; commitment transaction*) and the *remote node's outputs* (in the 
</I>&gt;&gt;<i> *remote node's
</I>&gt;&gt;<i> -commitment transaction*). So for example, if the local node publishes 
</I>&gt;&gt;<i> its
</I>&gt;&gt;<i> +commitment transaction*). If `option_simplified_commitment` applies
</I>&gt;&gt;<i> +to the commitment transaction, then the *to_remote* output of each 
</I>&gt;&gt;<i> commitment is
</I>&gt;&gt;<i> +identically encumbered, for fairness.
</I>&gt;&gt;<i> +
</I>&gt;&gt;<i> +Without `option_simplified_commitment`, if the local node publishes its
</I>&gt;&gt;<i> &#160; commitment transaction, it will have to wait to claim its own funds,
</I>&gt;&gt;<i> &#160; whereas the remote node will have immediate access to its own funds. 
</I>&gt;&gt;<i> As a
</I>&gt;&gt;<i> &#160; consequence, the two commitment transactions are not identical, but 
</I>&gt;&gt;<i> they are
</I>&gt;&gt;<i> @@ -140,6 +148,11 @@ A node:
</I>&gt;&gt;<i> &#160;&#160;&#160;&#160;&#160;&#160;&#160; - otherwise:
</I>&gt;&gt;<i> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; - MUST use the *last commitment transaction*, for which it 
</I>&gt;&gt;<i> has a
</I>&gt;&gt;<i> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; signature, to perform a *unilateral close*.
</I>&gt;&gt;<i> +&#160;&#160;&#160;&#160;&#160; - MUST spend any `to_local_pushme` output, providing sufficient 
</I>&gt;&gt;<i> fees as incentive to include the commitment transaction in a block
</I>&gt;&gt;<i> +&#160;&#160;&#160;&#160;&#160;&#160;&#160; - SHOULD use 
</I>&gt;&gt;<i> [replace-by-fee](<A HREF="https://github.com/bitcoin/bips/blob/master/bip-0125.mediawiki">https://github.com/bitcoin/bips/blob/master/bip-0125.mediawiki</A>) 
</I>&gt;&gt;<i> or other mechanism on the spending transaction if it proves 
</I>&gt;&gt;<i> insufficient for timely inclusion in a block.
</I>&gt;&gt;<i> +
</I>&gt;&gt;<i> +A node:
</I>&gt;&gt;<i> +&#160; - MAY monitor the blockchain for unspent `to_local_pushme` and 
</I>&gt;&gt;<i> `to_remote_pushme` outputs and try to spend them after 10 confirmations.
</I>&gt;&gt;<i> &#160; ## Rationale
</I>&gt;&gt;<i> @@ -154,7 +167,8 @@ need not consume resources monitoring the channel 
</I>&gt;&gt;<i> state.
</I>&gt;&gt;<i> &#160; There exists a bias towards preferring mutual closes over unilateral 
</I>&gt;&gt;<i> closes,
</I>&gt;&gt;<i> &#160; because outputs of the former are unencumbered by a delay and are 
</I>&gt;&gt;<i> directly
</I>&gt;&gt;<i> &#160; spendable by wallets. In addition, mutual close fees tend to be less 
</I>&gt;&gt;<i> exaggerated
</I>&gt;&gt;<i> -than those of commitment transactions. So, the only reason not to use 
</I>&gt;&gt;<i> the
</I>&gt;&gt;<i> +than those of commitment transactions (or in the case of 
</I>&gt;&gt;<i> `option_simplified_commitment`,
</I>&gt;&gt;<i> +the commitment transaction may require a child transaction to cause 
</I>&gt;&gt;<i> it to be mined). So, the only reason not to use the
</I>&gt;&gt;<i> &#160; signature from `closing_signed` would be if the fee offered was too 
</I>&gt;&gt;<i> small for
</I>&gt;&gt;<i> &#160; it to be processed.
</I>&gt;&gt;<i> diff --git a/09-features.md b/09-features.md
</I>&gt;&gt;<i> index d06fcff..caea38b 100644
</I>&gt;&gt;<i> --- a/09-features.md
</I>&gt;&gt;<i> +++ b/09-features.md
</I>&gt;&gt;<i> @@ -26,6 +26,7 @@ These flags may only be used in the `init` message:
</I>&gt;&gt;<i> &#160; | 3&#160; | `initial_routing_sync` | Indicates that the sending node 
</I>&gt;&gt;<i> needs a complete routing information dump | [BOLT 
</I>&gt;&gt;<i> #7](07-routing-gossip.md#initial-sync) |
</I>&gt;&gt;<i> &#160; | 4/5&#160; | `option_upfront_shutdown_script` | Commits to a shutdown 
</I>&gt;&gt;<i> scriptpubkey when opening channel | [BOLT 
</I>&gt;&gt;<i> #2](02-peer-protocol.md#the-open_channel-message) |
</I>&gt;&gt;<i> &#160; | 6/7&#160; | `gossip_queries`&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; | More sophisticated gossip 
</I>&gt;&gt;<i> control | [BOLT #7](07-routing-gossip.md#query-messages) |
</I>&gt;&gt;<i> +| 8/9&#160; | `option_simplified_commitment`&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; | Simplified 
</I>&gt;&gt;<i> commitment transactions | [BOLT #3](03-transactions.md) |
</I>&gt;&gt;<i> &#160; ## Assigned `globalfeatures` flags
</I>&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;<i> Lightning-dev mailing list
</I>&gt;&gt;<i> <A HREF="https://lists.linuxfoundation.org/mailman/listinfo/lightning-dev">Lightning-dev at lists.linuxfoundation.org</A>
</I>&gt;&gt;<i> <A HREF="https://lists.linuxfoundation.org/mailman/listinfo/lightning-dev">https://lists.linuxfoundation.org/mailman/listinfo/lightning-dev</A>
</I>&gt;&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Lightning-dev mailing list
</I>&gt;<i> <A HREF="https://lists.linuxfoundation.org/mailman/listinfo/lightning-dev">Lightning-dev at lists.linuxfoundation.org</A>
</I>&gt;<i> <A HREF="https://lists.linuxfoundation.org/mailman/listinfo/lightning-dev">https://lists.linuxfoundation.org/mailman/listinfo/lightning-dev</A>
</I></PRE>






















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="001644.html">[Lightning-dev] [PATCH] First draft of option_simplfied_commitment
</A></li>
	<LI>Next message: <A HREF="001651.html">[Lightning-dev] [PATCH] First draft of	option_simplfied_commitment
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1647">[ date ]</a>
              <a href="thread.html#1647">[ thread ]</a>
              <a href="subject.html#1647">[ subject ]</a>
              <a href="author.html#1647">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.linuxfoundation.org/mailman/listinfo/lightning-dev">More information about the Lightning-dev
mailing list</a><br>
</body></html>
